## Java Rule 19: Удаление моделей, полей, методов, событий

Часто при изменении бизнес-логики или выходе нового функционала, остаются старые поля, события, их обработчики, модели.


В таких ситуациях важно понимать:
  - На текущий момент наши системы накатки миграций пока что не умеют делать rollback с восстановлением и/или ренеймом 
моделей.
  - В кафке любые события могут стоять события в очереди, при выкатке нового функционала важно учесть обработку старых 
событий.
  - On-premises клиенты могут использовать старые версии приложения.

### Удаление метода

- Если метод не используется, его можно удалить. Для библиотек (прим. `app-core` и `commons`) важно убедиться, что 
никто из сервисов метод не использует (так как такая проверка долгая, полезный утильный метод лучше оставить).
- Если метод используется обработчиками `@Deprecated` событий, удалять его нельзя.
- Неиспользуемые методы валидации необходимо удалять, но удалять коды ошибок, ставшие неиспользуемыми, нельзя 
(обратная совместимость), для таких ситуаций существует аннотация `@UnusedErrorCode`. Для ставшего неиспользуемым кода 
ошибки также стоит удалить I18n переводы (`messages.en`, `messages.ru`), предварительно убедившись, что они нигде 
больше не используются.
Пример:
```java
/**
* <p>Тип документа не реализован.</p>
*/
@UnusedErrorCode
EC_060(ErrorSemantics.INCORRECT_INPUT_PARAMS, null),
```

### Удаление модели

Часто модель становится ненужной, новые модели приходят на смену старым по разным причинам - сильное изменение 
бизнес-логики, объединение моделей и т.д. В таких случаях появляются модели, не используемые в бизнес-логике.
    

Подготовка модели к удалению:

1. Добавить документацию над моделью (пояснение, почему модель больше не используется) и аннотации `@UnusedModel` и
`@Deprecated`. Если модель заменяется какой-то новой, можно сделать на неё `@see`.
2. Удалить сервисы и методы, завязанные на этой модели, если нет противопоказаний (например, модель является таской - 
обработчики удаляться сразу не будут, то есть и некоторые методы сервиса останутся).
3. Поставить задачу в эпик “Внутренняя разработка” на окончательное удаление этой модели. В задаче указать, что ожидаем 
удаление не раньше, чем через месяц после постановки задачи ВР. Если удаление модели спровоцировано разработкой большой 
фичи, уточняем это в описании и прикрепляем ссылку на блокирующую задачу в `blockedBy`. 
4. Перед окончательным удалением разработчику уточнить у тимлида, можно ли уже удалять модель.


### Удаление поля

Некоторые поля становятся ненужными, это происходит чаще всего из-за изменений в бизнес-логике. 

Подготовка поля модели к удалению:

1. Добавить документацию над полем (пояснение, почему больше не используется) и аннотации `@UnusedField` и
`@Deprecated`.
2. Удалить использование поля в бизнес-логике, если нет противопоказаний (например, поле обновляется при обработке 
старых событий, которые еще могут произойти в системе).
3. Поставить задачу в эпик “Внутренняя разработка” на окончательное удаление этого поля. В задаче указать, что ожидаем
удаление не раньше, чем через месяц после постановки задачи ВР. Если удаление спровоцировано разработкой большой
фичи, уточняем это в описании и прикрепляем ссылку на блокирующую задачу в blockedBy.
4. Перед окончательным удалением разработчику уточнить у тимлида, можно ли уже удалять поле.


### Удаление моделей, связанных с событиями

Из-за изменений бизнес-логики события, их паблишеры и обработчики становятся ненужными.

#### Удаление publisher'ов

Паблишеры можно удалять сразу, так как никто публиковать событие уже не будет.

#### Удаление подписчиков и обработчиков


При удалении события сначала помечаем подписчики и их провайдеры как `@Deprecated` с комментарием о причине.
Удалять классы можно только при условиях:
- задача вышла в мастер
- все старые события уже обработались
- все `ON-PREMISES` клиенты уже накатили обновление, в котором это событие не публикуется, и все старые события у них 
обработались. Если `ON-PREMISES` клиенты ещё не накатили обновление, то при обновлении после удаления у них не 
обработаются старые события).

Таким образом, удалять подписчики и провайдеры **нельзя**, пока не будет достоверно известно, что на всех экземплярах 
приложения эти события не публикуются (aka почти никогда, т.к. некоторые онпремы не хотят обновляться до новых версий).
Даже если все уже обновились, мы не можем точно гарантировать, что на их инстансах все события уже обработались.

#### Удаление модели события

Модель события можно удалять только после удаления остальных моделей, а до этого модель события помечается @Deprecated.
